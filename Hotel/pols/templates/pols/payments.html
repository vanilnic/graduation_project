{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'pols/payments.css' %}">
    <!-- <link rel="script" href="{% static 'pols/script.js' %}"> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>Оплата заказа</title>
</head>
<body>
    <div class="container p-0">
        <header class="header row">
            <div class="logo ps-0 col-1">
                <a href="{% url 'index' %}"><img src="{% static 'pols/images/logo.png'%}"></a>
            </div>
            <div class="title col-2">
                <a class="title_label" href="{% url 'index' %}">HotelHaven</a>
            </div>
            <div class="qw col-3"></div>
            <div class="favorites col-2 row">
                <div class="qw col-3"></div>
                <div class="col-1 p-0">
                    <!-- <img src="../img/heart_off.png"> -->
                </div>
                <div class="favo col-2 ps-3">
                    <!-- <a class="favorites_label">Избранное</a> -->
                </div>
            </div>
            <div class="suitcase col-2 row">
                <div class="qw col-2"></div>
                <div class="qw col-1">
                    <!-- <img src="../img/suitcase.png"> -->
                </div>
                <div class="favo ps-3 col">
                    <!-- <a class="suitcase_label">Мои поездки</a> -->
                </div>
            </div>
            <div class="enter col">
                <!-- <button class="enter_button" data-bs-toggle="modal" href="#exampleModalToggle">Личный кабинет</button> -->
            </div>
        </header>
    </div>

    <div class="form_payments container-fluid d-flex justify-content-center">
        <form class="card_payments" method="post">
            {% csrf_token %}
            <div class="ps-0">
                <div class="title_hotel">
                    <label>{{ room.hotel.name }}</label>
                </div>
                <div class="title_room">
                    <label>{{ room.title }}</label>
                </div>
            </div>
            <div class="date_date">
                <div class="date">
                    <div class="row">
                        <div class="qw col">
                            <label class="dd">{{ arrival }}</label> <br>
                            <label class="tt">с 15:00</label>
                        </div>
                        <div class="tire col-1 ps-1">
                            <label class="dd">—</label>
                        </div>
                        <div class="qw col">
                            <label class="dd">{{ departure }}</label> <br>
                            <label class="tt">до 12:00</label>
                        </div>
                    </div>
                <div class="count_people row">
                    <label class="people col">{{ people }}</label>
                </div>
            </div>
            </div>
            <div class="itog_price">
                <label>Итого к оплате:</label>
                <label class="price">{{ total_price }} ₽</label>
            </div>
            <div class="d-flex justify-content-center">
                <div class="info_card">
                    <input class="card_input card_number" type="text" maxlength="19" placeholder="Номер карты" name="number_card">
                    <div class="pt-3 row">
                        <div class="date_c col">
                            <!-- <input class="card_input card_date" type="date"  placeholder="Срок действия" name="date_card"> -->
                            <input type="text" class="card_input card_date" placeholder="ДД.ММ.ГГГГ" name="date_card" maxlength="10">
                        </div>
                        <div class="cvv col">
                            <input class="card_input card_cvv" type="text" maxlength="3" placeholder="CVV код" name="cvv_card">
                        </div>
                    </div>
                </div>
            </div>
            <div class="button_p">
                <button class="pay_btn" type="submit">Оплатить</button>
            </div>
        </form>
    </div>
    <script>
    // для input номера карты
            document.querySelector('.card_number').addEventListener('input', function(e) {
            // Удаляем все нецифровые символы
            let value = e.target.value.replace(/\D/g, '');
            
            // Добавляем пробелы после каждых 4 цифр
            let formattedValue = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }
            
            e.target.value = formattedValue;
        });

        // Запрещаем ввод нецифровых символов
        document.querySelector('.card_number').addEventListener('keydown', function(e) {
            // Разрешаем: Backspace, Delete, Tab, стрелки
            if ([8, 9, 37, 38, 39, 40, 46].includes(e.keyCode)) {
                return;
            }
            // Запрещаем всё, кроме цифр
            if (e.keyCode < 48 || e.keyCode > 57) {
                if (e.keyCode < 96 || e.keyCode > 105) { // Проверка numpad
                    e.preventDefault();
                }
            }
        });

    // для input даты
        document.querySelector('.card_date').addEventListener('input', function(e) {
            const input = e.target;
            let value = input.value.replace(/\D/g, '');
            
            // Форматирование
            let formattedValue = '';
            if (value.length > 0) formattedValue = value.slice(0, 2);
            if (value.length > 2) formattedValue += '.' + value.slice(2, 4);
            if (value.length > 4) formattedValue += '.' + value.slice(4, 8);
            
            input.value = formattedValue;
            
            // Валидация в реальном времени
            validateDateInput(input);
        });
        // Проверка валидности даты
        function validateDateInput(input) {
            const errorElement = input.nextElementSibling;
            const [day, month, year] = input.value.split('.').map(Number);
            
            let isValid = true;
            
            // Проверяем заполненность всех частей
            if (input.value.length === 10) {
                // Проверяем день (1-31)
                if (day < 1 || day > 31) isValid = false;
                // Проверяем месяц (1-12)
                if (month < 1 || month > 12) isValid = false;
                // Проверяем год (1900-2099)
                if (year < 1900 || year > 2099) isValid = false;
                // Дополнительная проверка для месяцев с 30 днями
                if (month === 4 || month === 6 || month === 9 || month === 11) {
                    if (day > 30) isValid = false;
                }
                // Проверка февраля (упрощённая, без учёта високосных годов)
                if (month === 2 && day > 28) isValid = false;
            } else if (input.value.length > 0) {
                // Если введена неполная дата, но есть символы
                isValid = false;
            }
            // Подсветка ошибки
            if (!isValid && input.value.length > 0) {
                input.style.borderColor = 'red';
                errorElement.style.display = 'inline';
            } else {
                input.style.borderColor = '';
                errorElement.style.display = 'none';
            }
            return isValid;
        }
        // Валидация при отправке формы
        document.querySelector('form')?.addEventListener('submit', function(e) {
            const dateInput = document.querySelector('.card_date');
            if (!validateDateInput(dateInput)) {
                e.preventDefault();
                dateInput.focus();
            }
        });
        // Запрет ввода нецифровых символов
        document.querySelector('.card_date').addEventListener('keydown', function(e) {
            // Разрешаем: Backspace, Delete, Tab, стрелки
            if ([8, 9, 37, 38, 39, 40, 46].includes(e.keyCode)) return;
            // Запрещаем всё, кроме цифр
            if (e.keyCode < 48 || e.keyCode > 57) {
                if (e.keyCode < 96 || e.keyCode > 105) {
                    e.preventDefault();
                }
            }
        });
    </script>
</body>
</html>